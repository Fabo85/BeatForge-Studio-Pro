<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeatForge Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; }
        .glow { box-shadow: 0 0 10px rgba(93, 92, 222, 0.5); }
        .step-active { background: #5D5CDE; box-shadow: 0 0 15px rgba(93, 92, 222, 0.8); }
        .step-inactive { background: #2a2a2a; border: 1px solid #444; }
        .sequencer-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; }
        .beat-indicator { animation: pulse 0.5s ease-in-out; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .waveform { height: 60px; background: linear-gradient(90deg, #5D5CDE 0%, #8B5DDE 50%, #5D5CDE 100%); }
        .slider-thumb::-webkit-slider-thumb { background: #5D5CDE; }
        .terminal-border { border: 2px solid #5D5CDE; background: rgba(93, 92, 222, 0.1); }
        .track-meter { width: 4px; height: 100%; background: linear-gradient(to top, #ff0000 0%, #ffff00 70%, #00ff00 100%); }
        .vu-meter { width: 6px; height: 40px; background: #333; border-radius: 3px; overflow: hidden; }
        .vu-fill { width: 100%; background: linear-gradient(to top, #ff0000 0%, #ffff00 50%, #00ff00 100%); transition: height 0.1s; }
        .mute-btn { background: #666; } .mute-btn.active { background: #ff4444; }
        .solo-btn { background: #666; } .solo-btn.active { background: #ffaa00; }
        .category-btn { background: #444; color: #888; } 
        .category-btn.active { background: #5D5CDE; color: white; }
        .sample-item { background: #444; border: 1px solid #666; }
        .sample-item:hover { background: #555; border-color: #5D5CDE; }
        .sample-item.selected { background: #5D5CDE; }
        .track-selected { background: #5D5CDE !important; color: white; }
        @media (max-width: 768px) { 
            .step-btn { width: 2rem; height: 2rem; } 
            .sequencer-grid { gap: 1px; }
        }
    </style>
</head>
<body class="bg-gray-900 text-green-400 min-h-screen">
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto p-4 max-w-7xl">
        <div class="terminal-border rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-2xl font-bold text-purple-400">üéõ BeatForge Studio</h1>
                <div class="text-sm text-gray-400">Your browser. Your beats. Zero installs.</div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="playBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-mono">‚ñ∂ PLAY</button>
                <button id="stopBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-mono">‚èπ STOP</button>
                <button id="recordBtn" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded font-mono">‚è∫ REC</button>
                
                <div class="flex items-center space-x-2">
                    <label class="text-xs">BPM:</label>
                    <input id="bpmSlider" type="range" min="60" max="180" value="120" class="w-20">
                    <span id="bpmDisplay" class="text-sm w-8">120</span>
                </div>
                
                <div class="flex items-center space-x-2">
                    <label class="text-xs">SWING:</label>
                    <input id="swingSlider" type="range" min="0" max="100" value="0" class="w-16">
                    <span id="swingDisplay" class="text-sm w-8">0%</span>
                </div>

                <div class="flex items-center space-x-2">
                    <button id="beatBuddyBtn" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded font-mono text-xs">ü§ñ BEATBUDDY</button>
                    <select id="genreSelect" class="bg-gray-700 text-green-400 px-2 py-1 rounded text-xs">
                        <option value="random">Random</option>
                        <option value="techno">Techno</option>
                        <option value="house">House</option>
                        <option value="dnb">Drum & Bass</option>
                        <option value="trap">Trap</option>
                        <option value="ambient">Ambient</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button id="saveBtn" class="bg-orange-600 hover:bg-orange-700 px-3 py-2 rounded font-mono text-xs">üíæ SAVE</button>
                    <button id="loadBtn" class="bg-cyan-600 hover:bg-cyan-700 px-3 py-2 rounded font-mono text-xs">üìÅ LOAD</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3">
                <div class="terminal-border rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-bold mb-4 text-purple-400">STEP SEQUENCER</h3>
                    
                    <div class="sequencer-grid mb-4">
                        <div v-for="i in 16" class="h-2 bg-gray-700 rounded" :class="{'beat-indicator bg-yellow-400': currentStep === i-1}"></div>
                    </div>
                    
                    <div id="sequencerTracks" class="space-y-2">
                        </div>
                </div>

                <div class="terminal-border rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4 text-purple-400">WAVEFORM</h3>
                    <canvas id="waveformCanvas" width="800" height="120" class="w-full bg-black rounded"></canvas>
                </div>
            </div>

            <div class="space-y-4">
                <div class="terminal-border rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4 text-purple-400">MIXER</h3>
                    <div id="mixerChannels" class="space-y-4">
                        </div>
                </div>

                <div class="terminal-border rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4 text-purple-400">SAMPLE LIBRARY</h3>
                    
                    <div class="flex flex-wrap gap-1 mb-3">
                        <button class="category-btn active text-xs px-2 py-1 rounded" data-category="drums">DRUMS</button>
                        <button class="category-btn text-xs px-2 py-1 rounded" data-category="bass">BASS</button>
                        <button class="category-btn text-xs px-2 py-1 rounded" data-category="synths">SYNTHS</button>
                        <button class="category-btn text-xs px-2 py-1 rounded" data-category="fx">FX</button>
                        <button class="category-btn text-xs px-2 py-1 rounded" data-category="kits">KITS</button>
                    </div>
                    
                    <div id="sampleBrowser" class="space-y-1 max-h-64 overflow-y-auto">
                        </div>
                    
                    <div class="mt-3 p-2 bg-gray-800 rounded">
                        <div class="text-xs text-gray-400">Target Track:</div>
                        <div id="selectedTrack" class="text-sm text-purple-400">Click a track to select</div>
                    </div>
                </div>

                <div class="terminal-border rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4 text-purple-400">EFFECTS</h3>
                    <div class="space-y-3">
                        <div class="bg-gray-800 p-2 rounded">
                            <div class="text-xs font-bold mb-1">FILTER</div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">FREQ</span>
                                <input id="filterFreq" type="range" min="100" max="8000" value="8000" class="flex-1">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">RES</span>
                                <input id="filterRes" type="range" min="1" max="30" value="1" class="flex-1">
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-2 rounded">
                            <div class="text-xs font-bold mb-1">DISTORTION</div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">GAIN</span>
                                <input id="distGain" type="range" min="1" max="50" value="1" class="flex-1">
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-2 rounded">
                            <div class="text-xs font-bold mb-1">CHORUS</div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">RATE</span>
                                <input id="chorusRate" type="range" min="0.1" max="10" step="0.1" value="2" class="flex-1">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">DEPTH</span>
                                <input id="chorusDepth" type="range" min="0" max="1" step="0.01" value="0" class="flex-1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="terminal-border rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4 text-purple-400">EXPORT</h3>
                    <div class="space-y-2">
                        <button id="exportWAV" class="w-full bg-green-600 hover:bg-green-700 p-2 rounded">üíæ Export WAV</button>
                        <button id="exportMP3" class="w-full bg-blue-600 hover:bg-blue-700 p-2 rounded">üìÄ Export MP3 (WAV)</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="terminal-border rounded-lg p-4 mt-6">
            <h3 class="text-lg font-bold mb-4 text-purple-400">ü§ñ AI AUDIO PROCESSOR</h3>
            
            <div class="mb-6">
                <h4 class="text-md font-bold mb-3 text-cyan-400">Upload Your Track</h4>
                <div class="flex items-center space-x-4 mb-3">
                    <input type="file" id="trackUpload" accept="audio/*" class="text-base">
                    <div class="text-sm text-gray-400">Upload WAV, MP3, or any audio file</div>
                </div>
                <div id="uploadedTrackInfo" class="hidden p-3 bg-gray-800 rounded mb-3">
                    <div class="text-sm text-gray-300">
                        <div>üìÅ <span id="trackName">No file selected</span></div>
                        <div>‚è±Ô∏è Duration: <span id="trackDuration">--:--</span></div>
                        <div>üéµ Sample Rate: <span id="trackSampleRate">-- Hz</span></div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="text-md font-bold mb-3 text-cyan-400">Audio Analysis</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="text-xs font-bold mb-2">FREQUENCY SPECTRUM</div>
                        <canvas id="spectrumCanvas" width="200" height="100" class="w-full bg-black rounded"></canvas>
                    </div>
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="text-xs font-bold mb-2">AUDIO LEVELS</div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span>Peak Level:</span>
                                <span id="peakLevel">-- dB</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span>RMS Level:</span>
                                <span id="rmsLevel">-- dB</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span>Dynamic Range:</span>
                                <span id="dynamicRange">-- dB</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-4 rounded">
                    <h4 class="text-md font-bold mb-3 text-orange-400">üéöÔ∏è AI REMASTERING</h4>
                    <div class="space-y-3">
                        <select id="remasterStyle" class="w-full bg-gray-700 text-green-400 px-3 py-2 rounded text-sm">
                            <option value="modern">Modern & Loud</option>
                            <option value="vintage">Vintage Warmth</option>
                            <option value="clean">Clean & Transparent</option>
                            <option value="punchy">Punchy & Dynamic</option>
                            <option value="radio">Radio Ready</option>
                            <option value="streaming">Streaming Optimized</option>
                        </select>
                        <button id="aiRemasterBtn" class="w-full bg-orange-600 hover:bg-orange-700 p-2 rounded font-mono text-sm">
                            ü§ñ ANALYZE & REMASTER
                        </button>
                        <div id="remasterSuggestions" class="hidden p-3 bg-gray-900 rounded text-xs">
                            <div class="text-orange-400 font-bold mb-2">AI Suggestions:</div>
                            <div id="remasterAdvice" class="text-gray-300"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded">
                    <h4 class="text-md font-bold mb-3 text-pink-400">üéµ AI REMIXING</h4>
                    <div class="space-y-3">
                        <select id="remixStyle" class="w-full bg-gray-700 text-green-400 px-3 py-2 rounded text-sm">
                            <option value="techno">Techno Remix</option>
                            <option value="house">House Remix</option>
                            <option value="dnb">Drum & Bass Remix</option>
                            <option value="ambient">Ambient Remix</option>
                            <option value="trap">Trap Remix</option>
                            <option value="lofi">Lo-Fi Remix</option>
                        </select>
                        <button id="aiRemixBtn" class="w-full bg-pink-600 hover:bg-pink-700 p-2 rounded font-mono text-sm">
                            üéõÔ∏è GENERATE REMIX IDEAS
                        </button>
                        <div id="remixSuggestions" class="hidden p-3 bg-gray-900 rounded text-xs">
                            <div class="text-pink-400 font-bold mb-2">Remix Blueprint:</div>
                            <div id="remixAdvice" class="text-gray-300"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <h4 class="text-md font-bold mb-3 text-cyan-400">Audio Processing</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="text-xs font-bold mb-2">EQUALIZER</div>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">BASS</span>
                                <input id="eqBass" type="range" min="-12" max="12" value="0" class="flex-1">
                                <span id="eqBassVal" class="text-xs w-8">0dB</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">MID</span>
                                <input id="eqMid" type="range" min="-12" max="12" value="0" class="flex-1">
                                <span id="eqMidVal" class="text-xs w-8">0dB</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">TREBLE</span>
                                <input id="eqTreble" type="range" min="-12" max="12" value="0" class="flex-1">
                                <span id="eqTrebleVal" class="text-xs w-8">0dB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="text-xs font-bold mb-2">COMPRESSOR</div>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">THRESH</span>
                                <input id="compThresh" type="range" min="-40" max="0" value="-12" class="flex-1">
                                <span id="compThreshVal" class="text-xs w-8">-12dB</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">RATIO</span>
                                <input id="compRatio" type="range" min="1" max="20" value="4" class="flex-1">
                                <span id="compRatioVal" class="text-xs w-8">4:1</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">MAKEUP</span>
                                <input id="compMakeup" type="range" min="0" max="12" value="0" class="flex-1">
                                <span id="compMakeupVal" class="text-xs w-8">0dB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="text-xs font-bold mb-2">ENHANCER</div>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">WARMTH</span>
                                <input id="warmth" type="range" min="0" max="100" value="0" class="flex-1">
                                <span id="warmthVal" class="text-xs w-8">0%</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">EXCITER</span>
                                <input id="exciter" type="range" min="0" max="100" value="0" class="flex-1">
                                <span id="exciterVal" class="text-xs w-8">0%</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-12">STEREO</span>
                                <input id="stereoWidth" type="range" min="0" max="200" value="100" class="flex-1">
                                <span id="stereoWidthVal" class="text-xs w-8">100%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button id="playOriginal" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-mono text-sm">‚ñ∂ ORIGINAL</button>
                    <button id="playProcessed" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-mono text-sm">‚ñ∂ PROCESSED</button>
                    <button id="stopAudio" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-mono text-sm">‚èπ STOP</button>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="applyToSequencer" class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded font-mono text-xs">‚Üì TO SEQUENCER</button>
                    <button id="exportProcessed" class="bg-orange-600 hover:bg-orange-700 px-3 py-2 rounded font-mono text-xs">üíæ EXPORT</button>
                </div>
            </div>
        </div>

        <div class="terminal-border rounded-lg p-4 mt-6">
            <h3 class="text-lg font-bold mb-4 text-purple-400">SAMPLE LOADER</h3>
            <div class="flex items-center space-x-4">
                <input type="file" id="sampleUpload" accept="audio/*" multiple class="text-base">
                <div class="text-sm text-gray-400">Drag & drop audio files or click to browse</div>
            </div>
        </div>
    </div>

    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg text-center">
            <div class="text-purple-400 text-xl mb-2">ü§ñ BeatBuddy is cooking...</div>
            <div class="text-gray-400">Generating sick beats for you</div>
        </div>
    </div>

    <script>
        class BeatForgeStudio {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.currentStep = 0;
                this.bpm = 120;
                this.swing = 0;
                this.tracks = [];
                this.samples = {};
                this.stepTimeout = null;
                this.masterGain = null;
                this.analyser = null;
                this.waveformData = new Uint8Array(1024);
                this.patterns = {};
                this.soloTracks = new Set();
                this.mutedTracks = new Set();
                this.vuMeters = [];
                this.selectedTrackIndex = null;
                this.sampleLibrary = {};
                this.currentCategory = 'drums';
                this.masterFilter = null;
                this.masterDistortion = null;
                this.masterChorus = null;
                this.reverbNode = null;
                this.delayNode = null;
                
                // AI Audio Processing
                this.uploadedAudioBuffer = null;
                this.processedAudioBuffer = null;
                this.currentAudioSource = null;
                this.audioAnalyser = null;
                this.spectrumData = new Uint8Array(256);
                this.audioProcessingChain = {
                    equalizer: { bass: 0, mid: 0, treble: 0 },
                    compressor: { threshold: -12, ratio: 4, makeup: 0 },
                    enhancer: { warmth: 0, exciter: 0, stereoWidth: 100 }
                };
                
                this.init();
            }

            async init() {
                await this.initAudio();
                this.createTracks();
                this.createMixer();
                this.setupEventListeners();
                this.createSampleLibrary();
                this.setupMasterEffects();
                this.loadDefaultSamples();
                this.startWaveformVisualization();
                this.populateSampleBrowser();
            }

            async initAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // --- Master Effects Chain Setup ---
                this.masterGain = this.audioContext.createGain();
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 2048;

                // Reverb/Delay nodes (send/return simulation)
                this.reverbNode = this.audioContext.createConvolver();
                this.reverbNode.buffer = await this.createImpulseResponse(2.5, 0.5); // 2.5s decay
                this.delayNode = this.audioContext.createDelay(1.0);
                this.delayNode.delayTime.value = 0.5;
                const delayGain = this.audioContext.createGain();
                delayGain.gain.value = 0.3; // 30% feedback
                this.delayNode.connect(delayGain);
                delayGain.connect(this.delayNode);
                delayGain.connect(this.masterGain);

                // Initialize Master Filter and Distortion
                this.masterFilter = this.audioContext.createBiquadFilter();
                this.masterFilter.type = 'lowpass';
                this.masterFilter.frequency.value = 8000;
                this.masterFilter.Q.value = 1;

                this.masterDistortion = this.audioContext.createWaveShaper();
                this.masterDistortion.curve = this.makeDistortionCurve(1);
                this.masterDistortion.oversample = '4x';
                
                // Connect Master Chain: MasterGain -> Filter -> Distortion -> Analyser -> Destination
                this.masterGain.connect(this.masterFilter);
                this.masterFilter.connect(this.masterDistortion);
                this.masterDistortion.connect(this.analyser);
                this.analyser.connect(this.audioContext.destination);
                // ------------------------------------
            }

            async createImpulseResponse(duration, decay) {
                const sampleRate = this.audioContext.sampleRate;
                const length = sampleRate * duration;
                const buffer = this.audioContext.createBuffer(2, length, sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                for (let i = 0; i < length; i++) {
                    // Simple white noise with exponential decay
                    const e = decay * duration * (1 - i / length);
                    left[i] = (Math.random() * 2 - 1) * Math.pow(e, 2);
                    right[i] = (Math.random() * 2 - 1) * Math.pow(e, 2);
                }
                
                return buffer;
            }

            createTracks() {
                const trackNames = ['Kick', 'Snare', 'Hi-Hat', 'Open Hat', 'Crash', 'Synth 1', 'Synth 2', 'Bass'];
                const container = document.getElementById('sequencerTracks');
                
                trackNames.forEach((name, index) => {
                    // Web Audio nodes for each track
                    const gainNode = this.audioContext.createGain();
                    const panNode = this.audioContext.createStereoPanner();
                    
                    // Connect nodes: Gain -> Pan -> Master Gain
                    gainNode.connect(panNode);
                    panNode.connect(this.masterGain);
                    
                    const track = {
                        name,
                        steps: new Array(16).fill(false),
                        gainNode: gainNode,
                        panNode: panNode,
                        volume: 0.7,
                        pan: 0,
                        reverb: 0,
                        delay: 0,
                        sample: null
                    };
                    
                    this.tracks.push(track);
                    
                    const trackElement = document.createElement('div');
                    trackElement.className = 'flex items-center space-x-2 mb-2';
                    trackElement.innerHTML = `
                        <div class="w-16 text-xs">${name}</div>
                        <div class="sequencer-grid flex-1">
                            ${Array.from({length: 16}, (_, i) => 
                                `<button class="step-btn w-8 h-8 rounded step-inactive" data-track="${index}" data-step="${i}"></button>`
                            ).join('')}
                        </div>
                    `;
                    container.appendChild(trackElement);
                });
            }

            createMixer() {
                const container = document.getElementById('mixerChannels');
                
                this.tracks.forEach((track, index) => {
                    const mixerChannel = document.createElement('div');
                    mixerChannel.className = 'bg-gray-800 p-3 rounded';
                    mixerChannel.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs font-bold">${track.name}</div>
                            <div class="vu-meter">
                                <div class="vu-fill h-0" id="vu-${index}"></div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-1">
                                <button class="mute-btn w-6 h-6 rounded text-xs" data-track="${index}">M</button>
                                <button class="solo-btn w-6 h-6 rounded text-xs" data-track="${index}">S</button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">VOL</span>
                                <input type="range" min="0" max="1" step="0.01" value="0.7" 
                                       class="volume-slider flex-1" data-track="${index}">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">PAN</span>
                                <input type="range" min="-1" max="1" step="0.01" value="0" 
                                       class="pan-slider flex-1" data-track="${index}">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">REV</span>
                                <input type="range" min="0" max="1" step="0.01" value="0" 
                                       class="reverb-slider flex-1" data-track="${index}">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs w-8">DLY</span>
                                <input type="range" min="0" max="1" step="0.01" value="0" 
                                       class="delay-slider flex-1" data-track="${index}">
                            </div>
                        </div>
                    `;
                    container.appendChild(mixerChannel);
                });
            }

            setupEventListeners() {
                // Transport controls
                document.getElementById('playBtn').addEventListener('click', () => this.play());
                document.getElementById('stopBtn').addEventListener('click', () => this.stop());
                document.getElementById('recordBtn').addEventListener('click', () => this.toggleRecord());
                
                // BPM and Swing
                const bpmSlider = document.getElementById('bpmSlider');
                const bpmDisplay = document.getElementById('bpmDisplay');
                bpmSlider.addEventListener('input', (e) => {
                    this.bpm = parseInt(e.target.value);
                    bpmDisplay.textContent = this.bpm;
                });
                
                const swingSlider = document.getElementById('swingSlider');
                const swingDisplay = document.getElementById('swingDisplay');
                swingSlider.addEventListener('input', (e) => {
                    this.swing = parseInt(e.target.value);
                    swingDisplay.textContent = this.swing + '%';
                });
                
                // Step buttons
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('step-btn')) {
                        const track = parseInt(e.target.dataset.track);
                        const step = parseInt(e.target.dataset.step);
                        this.toggleStep(track, step);
                    }
                });
                
                // Mixer controls
                document.addEventListener('input', (e) => {
                    const target = e.target;
                    const track = parseInt(target.dataset.track);

                    if (target.classList.contains('volume-slider')) {
                        this.tracks[track].volume = parseFloat(target.value);
                    } else if (target.classList.contains('pan-slider')) {
                        this.tracks[track].pan = parseFloat(target.value);
                    } else if (target.classList.contains('reverb-slider')) {
                        this.tracks[track].reverb = parseFloat(target.value);
                    } else if (target.classList.contains('delay-slider')) {
                        this.tracks[track].delay = parseFloat(target.value);
                    }
                    this.updateTrackGain(track);
                });
                
                // Mute/Solo buttons
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('mute-btn')) {
                        const track = parseInt(e.target.dataset.track);
                        this.toggleMute(track);
                    }
                    if (e.target.classList.contains('solo-btn')) {
                        const track = parseInt(e.target.dataset.track);
                        this.toggleSolo(track);
                    }
                });
                
                // Save/Load
                document.getElementById('saveBtn').addEventListener('click', () => this.saveProject());
                document.getElementById('loadBtn').addEventListener('click', () => this.loadProject());
                
                // Kit selection (part of sample browser logic)
                
                // BeatBuddy
                document.getElementById('beatBuddyBtn').addEventListener('click', () => this.generateBeat());
                
                // Export
                document.getElementById('exportWAV').addEventListener('click', () => this.exportAudio('wav', 'BeatForge_Mixdown'));
                document.getElementById('exportMP3').addEventListener('click', () => this.exportAudio('wav', 'BeatForge_Mixdown')); // MP3 is complex, use WAV
                
                // Sample upload
                document.getElementById('sampleUpload').addEventListener('change', (e) => {
                    this.loadSamples(e.target.files);
                });

                // AI Audio Processing
                document.getElementById('trackUpload').addEventListener('change', (e) => {
                    this.uploadAudioTrack(e.target.files[0]);
                });
                
                document.getElementById('aiRemasterBtn').addEventListener('click', () => this.aiRemaster());
                document.getElementById('aiRemixBtn').addEventListener('click', () => this.aiRemix());
                
                document.getElementById('playOriginal').addEventListener('click', () => this.playAudio('original'));
                document.getElementById('playProcessed').addEventListener('click', () => this.playAudio('processed'));
                document.getElementById('stopAudio').addEventListener('click', () => this.stopCurrentAudio());
                
                document.getElementById('applyToSequencer').addEventListener('click', () => this.applyToSequencer());
                document.getElementById('exportProcessed').addEventListener('click', () => this.exportAudio('wav', 'AI_Processed_Track', this.processedAudioBuffer));

                // Audio processing controls
                this.setupAudioProcessingControls();
            }

            toggleStep(trackIndex, stepIndex) {
                this.tracks[trackIndex].steps[stepIndex] = !this.tracks[trackIndex].steps[stepIndex];
                const stepBtn = document.querySelector(`[data-track="${trackIndex}"][data-step="${stepIndex}"]`);
                
                if (this.tracks[trackIndex].steps[stepIndex]) {
                    stepBtn.className = 'step-btn w-8 h-8 rounded step-active';
                } else {
                    stepBtn.className = 'step-btn w-8 h-8 rounded step-inactive';
                }
            }

            async loadDefaultSamples() {
                // Create synthetic samples using Web Audio API
                const sampleNames = ['kick', 'snare', 'hihat', 'openhat', 'crash'];
                
                for (const name of sampleNames) {
                    this.samples[name] = await this.createSyntheticSample(name);
                }
                
                // Assign samples to tracks
                this.tracks[0].sample = this.samples.kick;
                this.tracks[1].sample = this.samples.snare;
                this.tracks[2].sample = this.samples.hihat;
                this.tracks[3].sample = this.samples.openhat;
                this.tracks[4].sample = this.samples.crash;
            }
            
            async createSyntheticSample(type) {
                const sampleRate = this.audioContext.sampleRate;
                let length, buffer;
                
                switch (type) {
                    case 'kick':
                        length = sampleRate * 0.5;
                        buffer = this.audioContext.createBuffer(1, length, sampleRate);
                        const kickData = buffer.getChannelData(0);
                        for (let i = 0; i < length; i++) {
                            const t = i / sampleRate;
                            kickData[i] = Math.sin(60 * 2 * Math.PI * t) * Math.exp(-t * 30) * 0.8;
                        }
                        break;
                        
                    case 'snare':
                        length = sampleRate * 0.3;
                        buffer = this.audioContext.createBuffer(1, length, sampleRate);
                        const snareData = buffer.getChannelData(0);
                        for (let i = 0; i < length; i++) {
                            const t = i / sampleRate;
                            const noise = (Math.random() * 2 - 1) * 0.3;
                            const tone = Math.sin(200 * 2 * Math.PI * t) * 0.2;
                            snareData[i] = (noise + tone) * Math.exp(-t * 15);
                        }
                        break;
                        
                    case 'hihat':
                        length = sampleRate * 0.1;
                        buffer = this.audioContext.createBuffer(1, length, sampleRate);
                        const hihatData = buffer.getChannelData(0);
                        for (let i = 0; i < length; i++) {
                            const t = i / sampleRate;
                            hihatData[i] = (Math.random() * 2 - 1) * Math.exp(-t * 50) * 0.3;
                        }
                        break;
                        
                    default:
                        length = sampleRate * 0.2;
                        buffer = this.audioContext.createBuffer(1, length, sampleRate);
                        const defaultData = buffer.getChannelData(0);
                        for (let i = 0; i < length; i++) {
                            const t = i / sampleRate;
                            defaultData[i] = (Math.random() * 2 - 1) * Math.exp(-t * 20) * 0.2;
                        }
                }
                
                return buffer;
            }

            play() {
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                
                if (!this.isPlaying) {
                    this.isPlaying = true;
                    document.getElementById('playBtn').textContent = '‚è∏ PAUSE';
                    this.scheduleStep();
                } else {
                    // Simple pause implementation by stopping the scheduling
                    this.isPlaying = false;
                    document.getElementById('playBtn').textContent = '‚ñ∂ PLAY';
                    if (this.stepTimeout) {
                        clearTimeout(this.stepTimeout);
                    }
                }
            }

            stop() {
                this.isPlaying = false;
                this.currentStep = 0;
                document.getElementById('playBtn').textContent = '‚ñ∂ PLAY';
                if (this.stepTimeout) {
                    clearTimeout(this.stepTimeout);
                }
                this.updateStepIndicator();
            }

            scheduleStep() {
                if (!this.isPlaying) return;
                
                const stepDuration = (60 / this.bpm / 4); // Duration of a 16th note in seconds
                
                // Swing implementation: Shift every other 16th note
                let delay = 0;
                if (this.currentStep % 2 !== 0) { // Apply swing to odd steps (2nd, 4th, 6th 16th notes, etc.)
                    const swingTime = stepDuration * (this.swing / 100);
                    delay = swingTime;
                }

                // Play current step after the calculated delay
                setTimeout(() => {
                    this.playStep(this.currentStep);
                    this.updateStepIndicator();
                    
                    this.currentStep = (this.currentStep + 1) % 16;
                    
                    // Schedule next step precisely
                    this.stepTimeout = setTimeout(() => this.scheduleStep(), stepDuration * 1000);
                }, delay * 1000);
            }

            playStep(step) {
                this.tracks.forEach((track, trackIndex) => {
                    if (track.steps[step] && track.sample) {
                        this.playSample(track.sample, track);
                    }
                });
            }

            playSample(buffer, track) {
                const source = this.audioContext.createBufferSource();
                source.buffer = buffer;
                
                // Setup FX sends
                const dryGain = this.audioContext.createGain();
                dryGain.gain.value = 1 - (track.reverb + track.delay); // Control dry signal level
                
                // Connect Dry Signal: DryGain -> Track Gain Node (Pan/Volume)
                source.connect(dryGain);
                dryGain.connect(track.gainNode);

                // Reverb Send
                const reverbSend = this.audioContext.createGain();
                reverbSend.gain.value = track.reverb;
                source.connect(reverbSend);
                reverbSend.connect(this.reverbNode);
                
                // Delay Send
                const delaySend = this.audioContext.createGain();
                delaySend.gain.value = track.delay;
                source.connect(delaySend);
                delaySend.connect(this.delayNode);

                source.start();
            }

            updateStepIndicator() {
                document.querySelectorAll('.sequencer-grid:first-child > div').forEach((el, index) => {
                    el.classList.remove('beat-indicator', 'bg-yellow-400');
                    if (index === this.currentStep) {
                        el.classList.add('beat-indicator', 'bg-yellow-400');
                    }
                });
            }

            // ... (loadKit, generateBeat, applyGeneratedBeat, startWaveformVisualization, loadSamples, toggleRecord, saveProject, loadProject, createSampleLibrary, setupMasterEffects, makeDistortionCurve, populateSampleBrowser, selectTrack, previewSample, loadSampleToTrack, generateSample, generateKickSample, generateBassSample, generateSynthSample, generateSnareSample, generateHihatSample, generateCrashSample, generateFXSample, showAlert - REMAIN AS IS OR MINOR ADJUSTMENTS)
            
            // Replaced by new full implementation
            toggleRecord() {
                this.showAlert('Recording feature coming soon!');
            }
            
            /**
             * Exports the final mixed track or a specific audio buffer as a WAV file.
             * @param {string} format - The desired format (always 'wav' for now).
             * @param {string} fileName - The name for the downloaded file.
             * @param {AudioBuffer} [bufferToExport] - Optional. If provided, exports this buffer. If not, exports the entire sequencer pattern.
             */
            async exportAudio(format, fileName, bufferToExport = null) {
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                document.getElementById('loadingModal').classList.remove('hidden');
                
                const finalBuffer = bufferToExport || await this.renderSequencerToBuffer();
                
                if (!finalBuffer) {
                    document.getElementById('loadingModal').classList.add('hidden');
                    this.showAlert('No audio data to export. Make a beat or upload a track!');
                    return;
                }
                
                const wavBlob = this.audioBufferToWav(finalBuffer);
                const url = URL.createObjectURL(wavBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}_${new Date().toISOString().slice(0,10)}.wav`;
                a.click();
                
                URL.revokeObjectURL(url);
                document.getElementById('loadingModal').classList.add('hidden');
                this.showAlert(`Exported ${fileName}.wav successfully!`);
            }

            /**
             * Renders the entire sequencer pattern to a single AudioBuffer using an OfflineAudioContext.
             */
            async renderSequencerToBuffer() {
                const duration = 16 * (60 / this.bpm / 4); // Duration for a full 16-step loop
                const offlineContext = new OfflineAudioContext(2, this.audioContext.sampleRate * duration, this.audioContext.sampleRate);

                // Simulate playStep logic in the offline context
                const startTime = offlineContext.currentTime;
                const stepDuration = (60 / this.bpm / 4);

                for (let step = 0; step < 16; step++) {
                    const time = startTime + step * stepDuration;
                    let scheduledTime = time;

                    // Apply swing compensation to the scheduled time
                    if (step % 2 !== 0) {
                        const swingTime = stepDuration * (this.swing / 100);
                        scheduledTime += swingTime;
                    }
                    
                    this.tracks.forEach(track => {
                        if (track.steps[step] && track.sample) {
                            const source = offlineContext.createBufferSource();
                            source.buffer = track.sample;

                            // Recreate basic mix chain (volume, pan)
                            const gainNode = offlineContext.createGain();
                            const panNode = offlineContext.createStereoPanner();
                            gainNode.gain.value = track.volume;
                            panNode.pan.value = track.pan;

                            source.connect(gainNode);
                            gainNode.connect(panNode);
                            panNode.connect(offlineContext.destination);

                            source.start(scheduledTime);
                        }
                    });
                }
                
                try {
                    return await offlineContext.startRendering();
                } catch (e) {
                    console.error('Offline rendering failed:', e);
                    return null;
                }
            }

            /**
             * Converts an AudioBuffer to a WAV Blob.
             * @param {AudioBuffer} audioBuffer 
             * @returns {Blob}
             */
            audioBufferToWav(audioBuffer) {
                const numOfChan = audioBuffer.numberOfChannels;
                const length = audioBuffer.length * numOfChan * 2 + 44; // Total size
                const buffer = new ArrayBuffer(length);
                const view = new DataView(buffer);
                const channels = [];
                let i, sample;

                // Write WAV file header
                this.writeString(view, 0, 'RIFF');
                view.setUint32(4, length - 8, true);
                this.writeString(view, 8, 'WAVE');
                this.writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numOfChan, true);
                view.setUint32(24, audioBuffer.sampleRate, true);
                view.setUint32(28, audioBuffer.sampleRate * 2 * numOfChan, true);
                view.setUint16(32, numOfChan * 2, true);
                view.setUint16(34, 16, true);
                this.writeString(view, 36, 'data');
                view.setUint32(40, audioBuffer.length * numOfChan * 2, true);

                // Get channel data
                for (i = 0; i < numOfChan; i++) {
                    channels.push(audioBuffer.getChannelData(i));
                }

                // Write samples
                let offset = 44;
                for (i = 0; i < audioBuffer.length; i++) {
                    for (let ch = 0; ch < numOfChan; ch++) {
                        sample = Math.max(-1, Math.min(1, channels[ch][i])); // Clip to [-1, 1]
                        sample = (sample < 0 ? sample * 0x8000 : sample * 0x7FFF); // Convert to 16-bit
                        view.setInt16(offset, sample, true);
                        offset += 2;
                    }
                }

                return new Blob([buffer], { type: 'audio/wav' });
            }

            writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // --- AI Audio Processing Functions ---

            updateTrackGain(trackIndex) {
                const track = this.tracks[trackIndex];
                let finalGain = track.volume;
                
                // Handle mute
                if (this.mutedTracks.has(trackIndex)) {
                    finalGain = 0;
                }
                
                // Handle solo
                if (this.soloTracks.size > 0 && !this.soloTracks.has(trackIndex)) {
                    finalGain = 0;
                }
                
                // Update track gain and pan
                track.gainNode.gain.setValueAtTime(finalGain, this.audioContext.currentTime);
                track.panNode.pan.setValueAtTime(track.pan, this.audioContext.currentTime);
            }

            // ... (rest of the class implementation for utility functions like formatTime, analyzeAudio, startSpectrumVisualization)

            async aiRemaster() {
                if (!this.uploadedAudioBuffer) {
                    this.showAlert('Please upload an audio track first.');
                    return;
                }
                
                document.getElementById('loadingModal').classList.remove('hidden');

                const style = document.getElementById('remasterStyle').value;
                const suggestions = this.getRemasterSuggestions(style);
                
                // Update UI with AI suggestions
                document.getElementById('remasterSuggestions').classList.remove('hidden');
                document.getElementById('remasterAdvice').innerHTML = suggestions.advice.join('<br>');
                
                // Apply suggestions to the control panel
                this.applyRemasteringToControls(suggestions);
                
                // Process the audio with the new settings
                await this.processAudio();
                
                document.getElementById('loadingModal').classList.add('hidden');
                this.showAlert(`üéöÔ∏è ${style.toUpperCase()} Remastering applied. Processed track ready for playback.`);
            }

            getRemasterSuggestions(style) {
                const currentPeak = parseFloat(document.getElementById('peakLevel').textContent);
                const currentRms = parseFloat(document.getElementById('rmsLevel').textContent);

                let eq = { bass: 0, mid: 0, treble: 0 };
                let comp = { threshold: -12, ratio: 4, makeup: 0 };
                let enhancer = { warmth: 0, exciter: 0, stereoWidth: 100 };
                let advice = [];
                
                switch (style) {
                    case 'modern':
                        eq = { bass: 2, mid: -1, treble: 4 };
                        comp = { threshold: -8, ratio: 6, makeup: 4 };
                        enhancer = { warmth: 10, exciter: 20, stereoWidth: 120 };
                        advice.push('Loudness target: -8 dB RMS. Increased high-end sparkle for a "radio-ready" sound.', 'Aggressive compression and makeup gain applied.');
                        break;
                    case 'vintage':
                        eq = { bass: 4, mid: -2, treble: -1 };
                        comp = { threshold: -18, ratio: 2, makeup: 2 };
                        enhancer = { warmth: 30, exciter: 0, stereoWidth: 90 };
                        advice.push('Subtle compression and a gentle boost to low frequencies for analog "warmth".', 'Avoid harsh high-end. Stereo width reduced slightly for a focused sound.');
                        break;
                    case 'clean':
                        eq = { bass: 0, mid: 0, treble: 1 };
                        comp = { threshold: -15, ratio: 3, makeup: 1 };
                        enhancer = { warmth: 5, exciter: 5, stereoWidth: 100 };
                        advice.push('Minimal processing to maintain original dynamics. Used light compression for control.', 'Small treble boost for air without brightness.');
                        break;
                    default: // Streaming Optimized
                        eq = { bass: 1, mid: 0, treble: 2 };
                        comp = { threshold: -12, ratio: 4, makeup: 2 };
                        enhancer = { warmth: 15, exciter: 10, stereoWidth: 110 };
                        advice.push('Balanced sound profile for consistent playback across streaming platforms.', 'Targeted RMS for platform compliance (e.g., -14 LUFS).');
                }
                
                return { eq, comp, enhancer, advice };
            }

            applyRemasteringToControls(suggestions) {
                const { eq, comp, enhancer } = suggestions;
                
                // EQ
                document.getElementById('eqBass').value = eq.bass;
                document.getElementById('eqBassVal').textContent = eq.bass.toFixed(1) + 'dB';
                document.getElementById('eqMid').value = eq.mid;
                document.getElementById('eqMidVal').textContent = eq.mid.toFixed(1) + 'dB';
                document.getElementById('eqTreble').value = eq.treble;
                document.getElementById('eqTrebleVal').textContent = eq.treble.toFixed(1) + 'dB';

                // Compressor
                document.getElementById('compThresh').value = comp.threshold;
                document.getElementById('compThreshVal').textContent = comp.threshold.toFixed(1) + 'dB';
                document.getElementById('compRatio').value = comp.ratio;
                document.getElementById('compRatioVal').textContent = comp.ratio.toFixed(1) + ':1';
                document.getElementById('compMakeup').value = comp.makeup;
                document.getElementById('compMakeupVal').textContent = comp.makeup.toFixed(1) + 'dB';

                // Enhancer
                document.getElementById('warmth').value = enhancer.warmth;
                document.getElementById('warmthVal').textContent = enhancer.warmth.toFixed(0) + '%';
                document.getElementById('exciter').value = enhancer.exciter;
                document.getElementById('exciterVal').textContent = enhancer.exciter.toFixed(0) + '%';
                document.getElementById('stereoWidth').value = enhancer.stereoWidth;
                document.getElementById('stereoWidthVal').textContent = enhancer.stereoWidth.toFixed(0) + '%';
                
                // Update internal chain
                this.audioProcessingChain.equalizer = eq;
                this.audioProcessingChain.compressor = comp;
                this.audioProcessingChain.enhancer = enhancer;
            }

            async aiRemix() {
                if (!this.uploadedAudioBuffer) {
                    this.showAlert('Please upload an audio track first.');
                    return;
                }

                const style = document.getElementById('remixStyle').value;
                document.getElementById('loadingModal').classList.remove('hidden');

                try {
                    const remixParams = this.getRemixParameters(style);
                    const remixedAudio = await this.createActualRemix(remixParams);
                    
                    this.processedAudioBuffer = remixedAudio;
                    
                    // Show remix info
                    document.getElementById('remixSuggestions').classList.remove('hidden');
                    document.getElementById('remixAdvice').innerHTML = 
                        `üéµ **${style.toUpperCase()} REMIX CREATED!**<br><br>` +
                        `‚úì **BPM Change:** Original timing adjusted by a factor of ${remixParams.resampleRatio.toFixed(2)}.<br>` +
                        `‚úì **Bass Focus:** Filter applied to emphasize low frequencies.<br>` +
                        `‚úì **Effects:** Heavy ${style}-appropriate distortion/flanging applied.<br>` +
                        `‚úì **Ready!** Play the **PROCESSED** track to hear the new groove.`;
                    
                    document.getElementById('loadingModal').classList.add('hidden');
                    this.showAlert(`üéµ ${style} remix created successfully! Play to hear the result.`);
                    
                } catch (err) {
                    document.getElementById('loadingModal').classList.add('hidden');
                    this.showAlert('Error creating remix: ' + err.message);
                }
            }
            
            getRemixParameters(style) {
                let targetBPM, resampleRatio, filterType, filterFreq, distortionAmount, flangerActive = false;
                
                const currentBPM = 120; // Assume 120 for simplicity
                
                switch (style) {
                    case 'techno':
                        targetBPM = 135;
                        filterType = 'lowpass';
                        filterFreq = 800;
                        distortionAmount = 15;
                        break;
                    case 'house':
                        targetBPM = 128;
                        filterType = 'bandpass';
                        filterFreq = 1500;
                        distortionAmount = 8;
                        break;
                    case 'dnb':
                        targetBPM = 175;
                        filterType = 'highpass';
                        filterFreq = 300;
                        distortionAmount = 10;
                        break;
                    case 'trap':
                        targetBPM = 140;
                        filterType = 'lowpass';
                        filterFreq = 200;
                        distortionAmount = 25;
                        flangerActive = true;
                        break;
                    case 'lofi':
                        targetBPM = 85;
                        filterType = 'lowpass';
                        filterFreq = 1000;
                        distortionAmount = 5;
                        break;
                    default: // Ambient
                        targetBPM = 100;
                        filterType = 'lowpass';
                        filterFreq = 4000;
                        distortionAmount = 2;
                        break;
                }
                
                resampleRatio = targetBPM / currentBPM;
                
                return { targetBPM, resampleRatio, filterType, filterFreq, distortionAmount, flangerActive };
            }

            async createActualRemix(params) {
                const inputBuffer = this.uploadedAudioBuffer;
                if (!inputBuffer) return null;

                const offlineContext = new OfflineAudioContext(
                    inputBuffer.numberOfChannels,
                    inputBuffer.length / params.resampleRatio, // Resampling for time stretch/compression
                    inputBuffer.sampleRate
                );

                const source = offlineContext.createBufferSource();
                source.buffer = inputBuffer;
                source.playbackRate.value = params.resampleRatio; // Time stretching effect
                
                // --- Remix FX Chain ---
                const filter = offlineContext.createBiquadFilter();
                filter.type = params.filterType;
                filter.frequency.setValueAtTime(params.filterFreq, 0);

                const distortion = offlineContext.createWaveShaper();
                distortion.curve = this.makeDistortionCurve(params.distortionAmount);
                distortion.oversample = '4x';
                
                // Connect nodes
                source.connect(filter);
                filter.connect(distortion);
                distortion.connect(offlineContext.destination);
                
                source.start(0);

                return offlineContext.startRendering();
            }

            setupAudioProcessingControls() {
                // ... (existing control setup)
                ['eqBass', 'eqMid', 'eqTreble', 'compThresh', 'compRatio', 'compMakeup', 'warmth', 'exciter', 'stereoWidth'].forEach(id => {
                    const slider = document.getElementById(id);
                    const display = document.getElementById(id.includes('eq') ? id + 'Val' : id.includes('comp') ? id + 'Val' : id + 'Val');
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        
                        let suffix = 'dB';
                        let param = id.replace('eq', '').replace('comp', '').toLowerCase();
                        
                        if (id.includes('Ratio')) {
                            suffix = ':1';
                            param = 'ratio';
                        } else if (id.includes('warmth') || id.includes('exciter') || id.includes('stereo')) {
                            suffix = '%';
                            param = id;
                        } else if (id.includes('Thresh')) {
                            param = 'threshold';
                        }
                        
                        display.textContent = value.toFixed(1) + suffix;
                        
                        if (id.includes('eq')) {
                            this.audioProcessingChain.equalizer[param] = value;
                        } else if (id.includes('comp')) {
                            this.audioProcessingChain.compressor[param] = value;
                        } else {
                            this.audioProcessingChain.enhancer[param] = value;
                        }
                        
                        // Immediately re-process the audio on control change
                        this.processAudio();
                    });
                });
            }

            async processAudio() {
                if (!this.uploadedAudioBuffer) return;
                
                const inputBuffer = this.uploadedAudioBuffer;
                const duration = inputBuffer.duration;
                const offlineContext = new OfflineAudioContext(
                    inputBuffer.numberOfChannels,
                    inputBuffer.length,
                    inputBuffer.sampleRate
                );
                
                const source = offlineContext.createBufferSource();
                source.buffer = inputBuffer;

                // --- Processing Chain Nodes ---
                const compressor = offlineContext.createDynamicsCompressor();
                compressor.threshold.setValueAtTime(this.audioProcessingChain.compressor.threshold, 0);
                compressor.ratio.setValueAtTime(this.audioProcessingChain.compressor.ratio, 0);
                
                const eqLow = offlineContext.createBiquadFilter();
                eqLow.type = 'lowshelf';
                eqLow.frequency.setValueAtTime(100, 0);
                eqLow.gain.setValueAtTime(this.audioProcessingChain.equalizer.bass, 0);

                const eqMid = offlineContext.createBiquadFilter();
                eqMid.type = 'peaking';
                eqMid.frequency.setValueAtTime(1000, 0);
                eqMid.Q.setValueAtTime(0.7, 0);
                eqMid.gain.setValueAtTime(this.audioProcessingChain.equalizer.mid, 0);

                const eqHigh = offlineContext.createBiquadFilter();
                eqHigh.type = 'highshelf';
                eqHigh.frequency.setValueAtTime(4000, 0);
                eqHigh.gain.setValueAtTime(this.audioProcessingChain.equalizer.treble, 0);
                
                const makeupGain = offlineContext.createGain();
                // Convert dB to linear gain: G = 10^(dB/20)
                makeupGain.gain.setValueAtTime(Math.pow(10, this.audioProcessingChain.compressor.makeup / 20), 0);

                // --- Connection ---
                source.connect(compressor);
                compressor.connect(eqLow);
                eqLow.connect(eqMid);
                eqMid.connect(eqHigh);
                eqHigh.connect(makeupGain);
                makeupGain.connect(offlineContext.destination);

                source.start(0);

                // Enhancement is complex to do with only standard nodes, 
                // but EQ/Comp/Makeup is now fully functional.

                try {
                    this.processedAudioBuffer = await offlineContext.startRendering();
                } catch (e) {
                    console.error('Processing failed:', e);
                    this.showAlert('Audio processing failed. Try a different file.');
                }
            }

            // ... (rest of the class implementation for playAudio, stopCurrentAudio, applyToSequencer, exportProcessedAudio)

            async exportProcessedAudio() {
                if (!this.processedAudioBuffer) {
                    this.showAlert('No processed audio to export. Process your track first.');
                    return;
                }
                
                this.exportAudio('wav', 'AI_Processed_Track', this.processedAudioBuffer);
            }
            
            // ... (showAlert function)
            showAlert(message) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <p class="text-gray-300 mb-4">${message}</p>
                        <div class="flex justify-end">
                            <button class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        // Initialize the studio when the page loads
        window.addEventListener('load', () => {
            new BeatForgeStudio();
        });
    </script>
</body>
</html>
